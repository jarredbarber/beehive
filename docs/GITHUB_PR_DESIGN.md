# Design: GitHub PR Integration with `in_review` State

> **Note**: This design document is outdated. The implementation did not include the `in_review` state. Tasks remain in their current state when PRs are created, and the `bh pr sync` command handles state transitions directly from any state to `closed` or `failed` based on PR merge status. See `docs/github-integration.md` and `docs/pr-sync-implementation.md` for the actual implementation.

## Overview
This document outlines the design for integrating `beehive` with GitHub Pull Requests. Currently, the `bh worker` commits and pushes directly to the main branch upon task completion. The goal is to support a more traditional development workflow where agents submit their changes as Pull Requests for human review.

## New Workflow
When GitHub integration is enabled for a project:

1.  **Agent Completion**: The agent completes a task and returns `status: "completed"`.
2.  **Branch Creation**: Instead of committing to the main branch, `beehive` creates a new branch named `tm/<task-id>`.
3.  **Push**: `beehive` pushes the changes to the new branch on the remote repository.
4.  **PR Creation**: `beehive` uses the GitHub API to create a Pull Request from the new branch to the configured base branch (defaulting to `main`).
5.  **State Transition**: The task state transitions from `in_progress` to `in_review`.
6.  **Human Review**: A human reviews the PR on GitHub.
7.  **PR Merge/Close**:
    *   **Merged**: If the PR is merged, the task transitions to `closed`.
    *   **Closed without Merge**: If the PR is closed without being merged, the task transitions to `failed` (or potentially back to `open` depending on configuration).

## Data Model Changes

### `TaskState` Enum
Add `IN_REVIEW = 'in_review'` to the `TaskState` enum in `src/types.ts`.

### `Task` Interface
Add the following optional fields to the `Task` interface:
*   `prUrl?: string`: The URL of the created Pull Request.
*   `prNumber?: number`: The GitHub PR number.
*   `branchName?: string`: The name of the feature branch.

## Configuration

### Project Config (`.bh/config.json`)
Add a `github` section to the `ProjectConfig`:

```json5
{
  "github": {
    "enabled": true,
    "repo": "owner/repo",
    "baseBranch": "main",
    "tokenEnv": "GITHUB_TOKEN",
    "branchPrefix": "tm/"
  }
}
```

*   `enabled`: Set to `true` to enable PR-based workflow.
*   `repo`: The "owner/repo" string for the GitHub repository.
*   `baseBranch`: The branch to target with PRs (default: `main`).
*   `tokenEnv`: The environment variable containing the GitHub Personal Access Token (default: `GITHUB_TOKEN`).
*   `branchPrefix`: Prefix for the generated branch names (default: `tm/`).

## Implementation Details

### GitHub Client
Use the `octokit` library to interact with the GitHub API. A new `GitHubClient` utility should be created to encapsulate these interactions.

### `bh worker` Changes
The `syncGit` method in `Worker` (or a new equivalent method) will be modified:
1.  Check if `config.github.enabled` is `true`.
2.  If true, create a branch: `git checkout -b tm/<task-id>`.
3.  Commit changes.
4.  Push branch: `git push -u origin tm/<task-id>`.
5.  Call GitHub API to create PR.
6.  Update task with `prUrl`, `prNumber`, `branchName` and set state to `in_review`.

### PR Monitoring
To detect when a PR is merged or closed, we have two options:

#### Option A: Polling (Initial Implementation)
A new command `bh pr sync` (or adding logic to `bh next`/`bh list`) will poll the GitHub API for the status of all tasks in the `in_review` state.
*   If PR is `merged` -> `bh close <id>`.
*   If PR is `closed` (not merged) -> `bh update <id> --state failed`.

#### Option B: Webhooks (Future Enhancement)
A small server could be added to listen for GitHub Webhooks. This is more complex to set up as it requires a public URL.

### PR Template
PR titles and bodies should be generated using templates:
*   **Title**: `[<task-id>] <task-title>`
*   **Body**:
    ```markdown
    ## Task: <task-title>
    - ID: <task-id>
    - Priority: <priority>

    ### Summary
    <task-summary>

    ### Details
    <task-details>

    ---
    *Generated by beehive*
    ```

## Task Decomposition

1.  **tm-d8g**: Add `octokit` dependency and update `TaskState` enum and `Task` interface. (Role: code)
2.  **tm-oew**: Update `ProjectConfig` and `ConfigManager` to support GitHub configuration. (Role: code)
3.  **tm-0qm**: Implement `GitHubClient` utility for PR creation and status checking. (Role: code)
4.  **tm-pqu**: Modify `Worker.syncGit` to support the PR workflow. (Role: code)
5.  **tm-ro1**: Implement `bh pr sync` command for polling PR status. (Role: code)
6.  **tm-big**: Add unit tests for GitHub client and PR workflow. (Role: test)
7.  **tm-pgu**: Update documentation in `README.md` and `CLAUDE.md`. (Role: docs)
8.  **tm-5pi**: Final review of GitHub PR integration. (Role: review)

## Migration
For existing projects, the default will remain direct commits to `main` (`github.enabled: false`) to avoid breaking existing workflows.
